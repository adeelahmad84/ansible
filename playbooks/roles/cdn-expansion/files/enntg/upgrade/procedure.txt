Please check the patching schedule is as per the portal referenced TG2557 (https://insightandplanning.sns.sky.com/apps#/ut/cdn/cells)
A-END	    Port	    B-END	    Port	CID
sr10.enntg   1/1/10	    ar21.enntg	    1/2	LOCAL

Dependencies:
This upgrade has a dependency on a successful completion of a layer 3 test on every circuit within this upgrade.

Summary of Steps
1. - Circuit Test
2. - Check Resiliency
3. - Pre-Checks
4. - Weight Traffic Off
5. - Apply Configuration
6. - Post-Checks
7. - Weight Traffic On
8. - Roll Back Scenario

1.0 Circuit Test:
=================

Unshut the ports and check the light levels on both circuits. Ensure that the values are within range.
SR10.ENNTG
***************************
configure port 1/1/10 no shutdown
show port 1/1/10 optical | match Value post-lines 5

##example output:
                              Value High Alarm  High Warn   Low Warn  Low Alarm
-------------------------------------------------------------------------------
Temperature (C)               +23.7     +78.0      +73.0       -8.0      -13.0
Supply Voltage (V)             3.34      3.70       3.60       3.00       2.90
Tx Bias Current (mA)           37.9      85.0       80.0       20.0       15.0
Tx Output Power (dBm)         -1.39      2.00       1.00      -7.00      -8.00


If there are any circuits out of range please perform basic troubleshooting.

If you cannot resolve poor light readings, please put this change on hold.

Assuming the light levels are satisfactory, we will test the circuits. Apply the configuration below to test the new circuit

SR10.ENNTG
***************************
clear port 1/1/10 statistics

/configure router interface "base_ar21.enntg_l3_test"
port 1/1/10
address 84.38.37.248/31
no shutdown

AR21.ENNTG
***************************
clear counters Te1/2

configure terminal

interface Te1/2
ip address 84.38.37.249 255.255.255.254
no shut
end

ping 84.38.37.248 repeat 1000 df-bit

Check the interface for errors
show interface Te1/2 | inc error

SR10.ENNTG
***************************
ping 84.38.37.249 count 1000 rapid do-not-fragment
show port 1/1/10 ethernet detail | match errors ignore-case

/configure router interface "base_ar21.enntg_l3Test"
  no port
  shutdown
/configure router
  no interface base_ar21.enntg_l3Test

AR21.ENNTG
***************************
configure terminal

interface Te1/2
no ip address
end

2.0 - Check Resiliency
======================

ar21.enntg
==============
ar21.enntg#term len 0

- Check that LACP is active on the resilient interface and that the ports are in an operational status. They should be up and enabled.
- Check that there is traffic currently traversing the resilient LAG/BUNDLE ports.

ar21.enntg#
show lacp 1 neighbor
show lacp 1 counters
show lacp 1 internal
show interfaces port-channel 1 counters

show lacp 3 neighbor
show lacp 3 counters
show lacp 3 internal
show interfaces port-channel 3 counters

3.0 - Pre-Checks
===============

Before proceeding with the upgrade, ensure that the following pre-checks have been adhered to.
- Check monitoring systems to ensure that there are no unreported errors.
- Ensure you are able to access both ar21.enntg and sr10.enntg inband.
- Please use URL: http://stats0.bllon.isp.sky.com/weathermaps/popcdn/popcdn_enntg.html to monitor the traffic between ar21.enntg and sr10.enntg.

ar21.enntg#show ip route static
sr10.enntg#show router static-route next-hop 2.120.7.47 
sr10.enntg#show router static-route next-hop 2a02:c78:1:c::5 

- Check the amount of circuits currently in the bundle.
- Check there is a current BGP session and that it is in an operational status.
- Check there is traffic currently traversing circuits in the bundle.

sr10.enntg
*******************
show lag 51 port
monitor lag 51
show router bgp neighbor 2.120.7.47  | match State

4.0 - Weight Traffic Off
========================

Please shutdown the static-routes and BGP neighbors on sr10.enntg to weight the traffic off.

SR10.ENNTG
****************************
configure router static-route next-hop 2.120.7.47  disable
configure router static-route next-hop 2a02:c78:1:c::5  disable
configure router bgp group "IN-POP-CDN" neighbor 2.120.7.47  shutdown


Monitor LAG on sr10.enntg to ensure traffic has dropped off all links in the LAG.

monitor lag 51

also monitor the URL: http://stats0.bllon.isp.sky.com/weathermaps/popcdn/popcdn_enntg.html


5.0 - Apply Configuration
=========================

Make sure the target interfaces on sr10.enntg are in a shut down state.

configure port 1/1/10 shutdown

Apply configuration to sr10.enntg

exit all
configure
    port 1/1/10
        description "[core,rd=ar21.enntg:te1-2,cid=LOCAL,iv-s=cdn_pop] IN-POP-CDN RACK_RACK_E006"
        ethernet
            mtu 8226
            hold-time up 5
        exit
        no shutdown
    exit
    lag 51
	shutdown
	no lacp
	port 1/1/10
	lacp active
	no shutdown
exit all

Apply configuration to ar21.enntg

ar21.enntg#
configure terminal
!
interface TenGigabitEthernet1/2
 description [core,rd=sr10.enntg:1-1-10,cid=LOCAL,iv-s=cdn_pop] UPLINK TO SR10.ENNTG
 no switchport
 mtu 8226
 no ip address
 no ip redirects
 flowcontrol receive off
 flowcontrol send off
 channel-protocol lacp
 channel-group 2 mode active
!
end
wr mem

5.0 - Post-Checks
================

- Check the all the circuits have joined the bundle and are in an active state.

sr10.enntg
*********************
show lag 51 port | match active | count
show port 1/1/10 ethernet efm-oam

ar21.enntg
**************
show interfaces port-channel 2 etherchannel | i Number

6.0 - Weight Traffic On
=======================

Please unshut the static-routes and BGP neighbors on sr10.enntg to weight the traffic on.

SR10.ENNTG
****************************
configure router static-route next-hop 2.120.7.47  enable
configure router static-route next-hop 2a02:c78:1:c::5  enable
configure router bgp group "IN-POP-CDN" neighbor 2.120.7.47  no shutdown


Monitor LAG on sr10.enntg to ensure traffic has picked up on all links in the LAG.

monitor lag 51

also monitor the URL: http://stats0.bllon.isp.sky.com/weathermaps/popcdn/popcdn_enntg.html

Please wait 5 minutes while monitoring the interfaces to ensure both uplinks are functioning as expected. When you are happy traffic is flowing through pr2.hobir the change is complete.

At this stage, the change is now complete.

7.0 - Roll Back Scenario
=======================

Make sure traffic is weighted off sr10.enntg before rolling back.

SR10.ENNTG
****************************
configure router static-route next-hop 2.120.7.47  disable
configure router static-route next-hop 2a02:c78:1:c::5  disable
configure router bgp group "IN-POP-CDN" neighbor 2.120.7.47  shutdown

Monitor interfaces on sr10.enntg to ensure traffic has dropped off all links in the bundle.

monitor lag 51

After traffic has been weighted off successfully, shut down the ports.

sr10.enntg
******************
exit all
configure
    port 1/1/10
        description "[no-mon,core,rd=ar21.enntg:te1-2,cid=LOCAL,iv-s=cdn_pop] IN-POP-CDN RACK_RACK_E006"
        shutdown
    exit
    lag 51
	shutdown
	no lacp
	no port 1/1/10
	lacp active
	no shutdown
exit all

Apply configuration to ar21.enntg

ar21.enntg#
configure terminal
!
interface TenGigabitEthernet1/2
 description [no-mon,core,rd=sr10.enntg:1-1-10,cid=LOCAL,iv-s=cdn_pop] UPLINK TO SR10.ENNTG
 no channel-group 2
 no channel-protocol lacp
!
end
wr mem


Post Checks
===========
- Check the amount of circuits currently in the bundle. There should be the same amount as pre-checks

sr10.enntg
show lag 51 port | match active | count


After all post-checks have been completed we can weight traffic back onto the bundle

Please unshut the static-routes and BGP neighbors on sr10.enntg to weight the traffic on.

SR10.ENNTG
****************************
configure router static-route next-hop 2.120.7.47  enable
configure router static-route next-hop 2a02:c78:1:c::5  enable
configure router bgp group "IN-POP-CDN" neighbor 2.120.7.47  no shutdown


Monitor LAG on sr10.enntg to ensure traffic has picked up on all links in the LAG.

monitor lag 51

also monitor the URL: http://stats0.bllon.isp.sky.com/weathermaps/popcdn/popcdn_enntg.html

Please wait 5 minutes while monitoring the interfaces to ensure both uplinks are functioning as expected. When you are happy traffic is flowing through pr2.hobir the change is complete.

Roll back is now complete
