exit all
/configure
{% for item, info in bbpe.3.ports|dictsort %}
    port {{ info.port }}
        description "[core,rd={{ hostname }}:te{{ info.remote_port|replace('/','-') }},cid=LOCAL,iv-s=cdn_pop] IN-POP-CDN {{ rack }}"
        ethernet
            mtu 8226
            hold-time up 5
        exit
        no shutdown
    exit
{% endfor %}
    lag {{ bbpe.3.lag }}
        description "[core,rd={{ hostname }}:pc{{ bbpe.3.channel }},iv-s=cdn_pop] IN-POP-CDN BUNDLE TO {{ hostname|upper }}"
{% for item, info in bbpe.3.ports|dictsort %}
	port {{ info.port }}
{% endfor %}
	lacp active
	port-threshold {{ ((bbpe.3.ports|length / 3)|round|int * 2) - 1 }} action down
        no shutdown
    exit
    router
{% if second %}
	interface "IN-POP-CDN-LINK-2"
{% else %}
	interface "IN-POP-CDN-LINK"
{% endif %}
	    address {{ bbpe.3.ipv4_p2p | ipaddr('0') }}
            description "[core,rd={{ hostname }}:pc{{ bbpe.3.channel }},iv-s=cdn_pop]"
            port lag-{{ bbpe.3.lag }}
            ipv6
                address {{ bbpe.3.ipv6_p2p }}
            exit
            cflowd interface both
            no shutdown
        exit
        static-route {{ loopback }} next-hop {{ bbpe.3.ipv4_p2p | ipaddr('1')|replace('/31',' ') }} tag 20100
        policy-options
            begin
            prefix-list "PL-POP-CDN-LOOPBACK"
                prefix {{ loopback }} exact
            exit
{% if not second %}
            policy-statement "EXPORT-TO-IBGP"
                entry 48
                    description "CDN-AR20-Lo0 static needs to be allowed prior to blocking infrastructure range"
                    from
                        protocol static
                        prefix-list "PL-POP-CDN-LOOPBACK"
                        tag 0x4e84
                    exit
                    to
                        protocol bgp
                    exit
                    action accept
                        community add "Subconfed-local"
                        next-hop-self
                    exit
		exit
            exit
{% endif %}
	    commit
	exit
        bgp
            group "IN-POP-CDN"
{% if not second %}
                family ipv4
                damping
                next-hop-self
                type internal
                export "EXPORT-TO-IBGP"
                disable-communities extended
{% endif %}
                neighbor {{ bbpe.3.ipv4_p2p | ipaddr('1')|replace('/31',' ') }}
                    description "{{ hostname }}"
                    authentication-key "{{ bbpe.3.bgp_auth }}"
                    import "IN-POP-CDN-PREFIXES"
                    export "SKY-LOCAL-USER-PREFIXES"
exit all
